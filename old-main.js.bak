class LetterHuntGame {
    constructor() {
        this.boardSize = 15 * 15; // 225
        this.letters = [];
        this.solutionIndices = new Set(); // Store correct answers
        this.currentLevel = 1;
        this.targets = [];
        this.selectedIndices = new Set();

        this.boardEl = document.getElementById('game-board');
        this.instructionEl = document.getElementById('instruction');
        this.refreshBtn = document.getElementById('refresh-btn');
        this.inputEl = document.getElementById('count-input');
        this.checkBtn = document.getElementById('check-btn');
        this.continueBtn = document.getElementById('continue-btn');
        this.feedbackEl = document.getElementById('feedback-msg');

        this.init();
    }

    init() {
        this.refreshBtn.addEventListener('click', () => {
            this.currentLevel = 1;
            this.generateNewGame();
        });
        this.checkBtn.addEventListener('click', () => this.checkAnswer());
        this.continueBtn.addEventListener('click', () => this.startLevel2());
        this.generateNewGame();
    }

    startLevel2() {
        this.currentLevel = 2;
        this.generateNewGame();
    }

    generateNewGame() {
        this.selectedIndices.clear();
        this.solutionIndices.clear();
        this.letters = new Array(this.boardSize).fill(null);
        this.inputEl.value = '';
        this.feedbackEl.textContent = '';
        this.feedbackEl.className = 'feedback-msg';
        this.continueBtn.style.display = 'none';
        this.checkBtn.style.display = 'inline-block';

        if (this.currentLevel === 1) {
            this.generateLevel1();
        } else {
            this.generateLevel2();
        }

        this.render();
    }

    generateLevel1() {
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        const targetChar = alphabet[Math.floor(Math.random() * alphabet.length)];
        this.targets = [targetChar];

        const totalTiles = this.boardSize;
        const minTarget = Math.ceil(totalTiles * 0.30);
        const maxTarget = Math.floor(totalTiles * 0.40);
        const targetCount = Math.floor(Math.random() * (maxTarget - minTarget + 1)) + minTarget;

        let indices = Array.from({ length: totalTiles }, (_, i) => i);
        // Shuffle manual
        for (let i = indices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [indices[i], indices[j]] = [indices[j], indices[i]];
        }

        // Place targets
        for (let i = 0; i < targetCount; i++) {
            this.letters[indices[i]] = targetChar;
            this.solutionIndices.add(indices[i]);
        }

        // Fill rest
        for (let i = targetCount; i < totalTiles; i++) {
            let char;
            do {
                char = alphabet[Math.floor(Math.random() * alphabet.length)];
            } while (char === targetChar);
            this.letters[indices[i]] = char;
        }

        this.instructionEl.innerHTML = `Level 1: Select all the <span class="highlight">${targetChar}</span>'s`;
    }

    generateLevel2() {
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
        // Shuffle alphabet to pick 2 distinct targets
        for (let i = alphabet.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [alphabet[i], alphabet[j]] = [alphabet[j], alphabet[i]];
        }
        const t1 = alphabet[0];
        const t2 = alphabet[1];
        this.targets = [t1, t2];

        const totalTiles = this.boardSize;
        const minTarget = Math.ceil(totalTiles * 0.30);
        const maxTarget = Math.floor(totalTiles * 0.40);
        const targetCount = Math.floor(Math.random() * (maxTarget - minTarget + 1)) + minTarget;

        let indices = Array.from({ length: totalTiles }, (_, i) => i);
        // Shuffle indices
        for (let i = indices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [indices[i], indices[j]] = [indices[j], indices[i]];
        }

        // Place targets (Mix of T1 and T2)
        for (let i = 0; i < targetCount; i++) {
            // Randomly pick T1 or T2
            const useT1 = Math.random() < 0.5;
            this.letters[indices[i]] = useT1 ? t1 : t2;
            this.solutionIndices.add(indices[i]);
        }

        // Fill rest with NON-target chars
        for (let i = targetCount; i < totalTiles; i++) {
            let char;
            do {
                // Pick random char that is NEITHER t1 NOR t2
                char = alphabet[Math.floor(Math.random() * alphabet.length)]; // alphabet is already shuffled but contains all chars
                // Wait, alphabet array contains T1 and T2 at 0 and 1. 
                // Cleaner: use a string and filter? Or just loop until valid.
            } while (char === t1 || char === t2);
            this.letters[indices[i]] = char;
        }

        this.instructionEl.innerHTML = `Level 2: Select the words <span class="highlight">${t1}</span> and <span class="highlight">${t2}</span>`;
    }

    render() {
        this.boardEl.innerHTML = '';
        this.letters.forEach((letter, index) => {
            const tile = document.createElement('div');
            tile.classList.add('tile');
            tile.textContent = letter;
            tile.dataset.index = index;
            tile.addEventListener('click', () => this.toggleSelection(index, tile));
            this.boardEl.appendChild(tile);
        });
    }

    toggleSelection(index, tileElement) {
        if (this.selectedIndices.has(index)) {
            this.selectedIndices.delete(index);
            tileElement.classList.remove('selected');
        } else {
            this.selectedIndices.add(index);
            tileElement.classList.add('selected');
        }
    }

    checkAnswer() {
        const userCount = parseInt(this.inputEl.value);
        if (isNaN(userCount)) {
            this.feedbackEl.textContent = "Please enter a number!";
            this.feedbackEl.className = 'feedback-msg feedback-error';
            return;
        }

        const actualCount = this.solutionIndices.size;

        // Highlight logic
        const tiles = this.boardEl.querySelectorAll('.tile');
        tiles.forEach((tile, index) => {
            const isSolution = this.solutionIndices.has(index);
            if (isSolution) {
                if (userCount === actualCount) {
                    tile.classList.add('correct');
                    tile.classList.remove('wrong');
                } else {
                    tile.classList.add('wrong');
                    tile.classList.remove('correct');
                }
            } else {
                tile.classList.remove('correct', 'wrong');
            }
        });

        if (userCount === actualCount) {
            this.feedbackEl.textContent = "Congratulations! You found them all.";
            this.feedbackEl.className = 'feedback-msg feedback-success';

            if (this.currentLevel === 1) {
                this.checkBtn.style.display = 'none';
                this.continueBtn.style.display = 'inline-block';
            }
        } else {
            this.feedbackEl.textContent = `Try again. (There are ${actualCount})`;
            this.feedbackEl.className = 'feedback-msg feedback-error';
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new LetterHuntGame();
});
